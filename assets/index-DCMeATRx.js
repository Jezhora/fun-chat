var D=Object.defineProperty;var F=(t,e,n)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var u=(t,e,n)=>(F(t,typeof e!="symbol"?e+"":e,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();class w{constructor(e,n){u(this,"tag");u(this,"className");u(this,"element");this.tag=e,this.className=n,this.element=document.createElement(e),this.element.className=n}addToParent(e){e.appendChild(this.element)}}class A extends w{constructor(n,s,o){super("button",n);u(this,"button");this.button=this.element,this.button.type=s,o&&this.button.addEventListener("click",o)}}class G extends w{constructor(n,s,o){super("input",n);u(this,"value");u(this,"type");u(this,"isValid");const a=this.element;a.placeholder=o,a.type=s,this.type=s,this.value="",this.isValid=!1,this.validateInput()}validateInput(){this.element.addEventListener("input",n=>{const s=n.target;let o=/^[a-zA-Z0-9]*$/;this.type==="password"&&(o=/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9-]+$/),this.isValid=o.test(s.value),this.value=s.value;const a=new CustomEvent("inputValidated",{detail:this.isValidInput()});document.dispatchEvent(a)})}isValidInput(){return this.isValid}getInputValue(){return this.value.trim()}}function r(t,e,n){const s=new w(t,e);return n&&s.addToParent(n),s.element}function g(t,e,n,s){const o=s?new A(t,e,s):new A(t,e);return o.element.textContent=n,o.element}function v(t,e,n,s){const o=new G(t,e,n);return s&&o.addToParent(s),o}function P(t,e,n){const s={id:n,login:t,password:e};sessionStorage.setItem("chat-user",JSON.stringify(s))}function b(){const t=sessionStorage.getItem("chat-user");return t?JSON.parse(t):null}function J(){sessionStorage.removeItem("chat-user")}function h(){const t="0123456789",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n="-_",s=t+e+n,o=7;let a="";a+=t.charAt(Math.floor(Math.random()*t.length)),a+=n.charAt(Math.floor(Math.random()*n.length));for(let i=2;i<=o;i+=1)a+=s.charAt(Math.floor(Math.random()*s.length));return a=a.split("").sort(()=>.5-Math.random()).join(""),a}function _(t,e){const n=r("div","title",t);n.textContent=e}function $(){const t=document.createDocumentFragment(),e=r("div","chat__user");r("div","chat__user-info",e);const n=r("div","chat__wrapper",e),s=r("div","chat__user-message",n);_(s,"Pick user and go FUN_CHAT!");const o=r("form","chat__send",e);v("send-input","text","write message",o).element.setAttribute("disabled","true");const i=g("btn send-button","submit","send");return i.setAttribute("disabled","true"),o.appendChild(i),t.append(e),t}function B(t){const e=new Date(t),n=e.toLocaleString("en-GB",{weekday:"short"}),s=e.getDate(),o=e.toLocaleString("en-GB",{month:"short"}),a=e.getFullYear(),i=e.toLocaleTimeString("en-GB",{hourCycle:"h23",hour:"2-digit",minute:"2-digit",second:"2-digit"});return`${n}, ${s} ${o} ${a}, ${i}`}function H(t,e){const{isReaded:n,isDelivered:s}=t;let o;if(e&&typeof t=="boolean")o=e;else switch(!0){case n:o="Read";break;case s:o="Delivered";break;default:o="Sent";break}return o}function C(t,e){const n=document.createDocumentFragment(),s=r("div","message",n);s.setAttribute("id",t.id),t.status.isDelivered&&s.classList.add("delivered");const o=r("p","message-status");if(e===t.from){const c=r("p","message-to",s);c.textContent=`To ${t.to}`,s.style.marginLeft="auto",s.style.marginRight="0",o.textContent=H(t.status)}else{const c=r("p","message-from",s);c.textContent=`From ${t.from}`}const a=r("p","message-date",s);a.textContent=B(t.datetime);const i=r("p","message-text",s);return i.textContent=t.text,s.appendChild(o),n}async function W(t,e){const n=document.querySelector(".chat__user-message");t.forEach(s=>{const o=C(s,e);n.appendChild(o)})}function z(t){const e=document.querySelector(".chat__user-message");m(e);const n={id:h(),type:"MSG_FROM_USER",payload:{user:{login:t}}},{ws:s}=y;s.send(JSON.stringify(n)),setTimeout(()=>{Array.from(e.children).some(a=>a.classList.contains("message"))||(_(e,"write your message"),_(e,`to ${t}`))},100)}function T(t){const e=document.querySelector(".chat__user-info"),{login:n,isLogined:s}=t;m(e);const o=r("div","user user-login",e);o.textContent=n;const a=r("div","user user-status",e);s?(a.classList.add("user-online"),a.textContent="online"):(a.classList.add("user-offline"),a.textContent="offline")}const S=t=>{Array.from(t.children).forEach(e=>{if(e.classList.contains("delivered")){const n={id:h(),type:"MSG_READ",payload:{message:{id:e.id}}},{ws:s}=y;s.send(JSON.stringify(n)),e.classList.remove("delivered")}})};function Z(){const t=document.querySelector(".chat__user-message"),e=document.querySelector(".send-input");t.addEventListener("click",()=>{S(t)}),t.addEventListener("scroll",()=>{S(t)}),e.addEventListener("input",()=>{e.value.length>0&&S(t)})}function x(t){const{id:e,status:n,text:s}=t,o=document.getElementById(e);if(o){const a=o.querySelector(".message-status"),i=o.querySelector(".message-text");let c;if(a){switch(!0){case n.isReaded:c="Read";break;case n.isEdited:c=`Edited ${o.textContent}`,i.textContent=s;break;default:c="Delivered",o.classList.add("delivered");break}a.textContent=c}}}async function X(t,e,n){const s=document.querySelector(".user-login"),o=document.querySelector(".chat__user-message");if(Array.from(o.children).some(i=>i.classList.contains("message"))||m(o),s&&(s.textContent===t.from||s.textContent===t.to)){const c=C(t,e);document.querySelector(".chat__user-message").appendChild(c)}}function Y(t,e){t.value.length>0?e.removeAttribute("disabled"):e.setAttribute("disabled","true")}function j(t){const e=document.querySelector(".chat__send"),n=e.firstChild,s=e.lastChild;n.removeAttribute("disabled"),n.addEventListener("input",a=>{const i=a.target;i&&Y(i,s)});const{ws:o}=y;e.onsubmit=a=>{a.preventDefault();const i={id:h(),type:"MSG_SEND",payload:{message:{to:t,text:n.value}}};o.send(JSON.stringify(i)),n.value="",s.setAttribute("disabled","true")}}function K(t){const e=t.target;if(e&&e.classList.contains("user")){const n=e.textContent,s=e.classList.contains("user-online"),o={login:n,isLogined:s};j(n),T(o),z(n),Z()}}function Q(t,e){const s=t.target.value.trim().toLowerCase();Array.from(e).forEach(o=>{var i;(i=o.textContent)!=null&&i.toLowerCase().startsWith(s)?o.classList.remove("hide"):o.classList.add("hide")})}function tt(){const t=document.createDocumentFragment(),e=r("div","chat__list"),n=v("chat__list-search","search","find user...",e).element,s=r("div","chat__list-wrapper",e),o=r("ul","chat__list-user",s);return n.addEventListener("input",a=>Q(a,o.children)),o.addEventListener("click",K),t.append(e),t}function et(t){const e=r("div","chat",t),n=tt(),s=$();e.append(n,s)}const nt=(t,e,n)=>{t.preventDefault();const s=document.querySelector(".modal");n.classList.remove("blur"),e.removeChild(s)};function st(){const t=document.querySelector(".container");t.classList.add("blur");const e=r("div","modal",document.body),n=r("div","modal__wrapper",e),s=r("div","about",n),o=r("div","about__info",s);o.textContent="This application was developed for the Fun Chat work assignments as part of the RSSchool JS/FE 2023Q4";const a=r("a","about__info",s);a.href="https://github.com/Jezhora",a.textContent="Yauheni Jezhora";const i=g("btn","button","back",c=>nt(c,document.body,t));s.appendChild(i)}const ot=t=>{t.preventDefault(),st()};function at(t){const e=r("h1","title",t);e.textContent="RS FUN-CHAT";const n=g("btn","button","ABOUT",ot);t.append(n)}function V(t){const e=document.querySelector(".logout");t.removeChild(e)}const it=t=>{t.preventDefault(),J(),vt(),E("/")};function I(t,e){const n=r("div","logout",t),s=r("p","logout__name",n);s.textContent=`${e}`;const o=g("btn","button","LOG OUT",it);n.appendChild(o)}function rt(t){const e=r("header","header",t);return at(e),e}const f=(t,e)=>{Array.from(t.children).forEach(n=>{n.classList.contains(e)&&t.removeChild(n)})},M=(t,e,n)=>{const s=r("div",e);t.appendChild(s),s.textContent=n};function O(t,e,n,s){const o=n.isValidInput(),{length:a}=n.getInputValue();a>=e&&o&&f(t,s),a<e&&(f(t,s),M(t,s,`Must contain at least ${e} symbols`)),a<1&&f(t,s),!o&&a>=e&&(f(t,s),M(t,s,s==="invalid-login"?"English letters, numbers are allowed":"Must contain uppercase and lowercase letters with numbers"))}function ct(t,e){const n=t.isValidInput(),s=e.isValidInput(),o=t.getInputValue().length,a=e.getInputValue().length,i=o>2&&a>3;return n&&s&&i}function ut(t,e,n,s){ct(t,e)?n.removeAttribute("disabled"):n.setAttribute("disabled","true"),O(s,3,t,"invalid-login"),O(s,4,e,"invalid-password")}async function dt(t,e,n){t.preventDefault();const s=h();k(e.value.trim(),n.value.trim(),s)}const lt=t=>{t.preventDefault(),E("/")};function p(t,e){const n=r("form","login",t),s=v("login__input user-name","text","login",n),o=v("login__input user-password","password","password",n),a=g("btn","submit","go chat");a.setAttribute("disabled","true"),document.addEventListener("inputValidated",()=>ut(s,o,a,n)),n.appendChild(a);const i=s.element,c=o.element;e&&(i.disabled=e,c.disabled=e),n.onsubmit=l=>dt(l,i,c)}function m(t){for(;t.firstChild;)t.removeChild(t.lastChild)}function mt(t,e="404 Page not found"){const n=r("p","title");n.textContent=e,n.style.fontSize="74px";const s=g("btn","button","GO LOGIN PAGE",lt);t.append(n,s)}const R=t=>{t.children.length>2&&V(t)};function L(t){const e=document.querySelector(".main"),n=document.querySelector(".header"),s=b();switch(t){case"/":m(e),s?(p(e,!0),V(n),I(n,s.login)):(p(e),R(n));break;case"/chat":m(e),s?(R(n),I(n,s.login),et(e)):mt(e,"To access, enter your login and password");break;default:m(e),p(e);break}}function E(t){window.history.pushState({path:t},"",t),L(t)}function ht(){const{ws:t}=y,n={id:h(),type:"USER_ACTIVE",payload:null},o={id:h(),type:"USER_INACTIVE",payload:null};t.send(JSON.stringify(n)),t.send(JSON.stringify(o))}function gt(t,e,n,s){const o={id:s,type:"USER_LOGIN",payload:{user:{login:e,password:n}}};t.send(JSON.stringify(o))}function ft(t,e,n,s,o){const a=JSON.parse(e.data),i=b();if(a.type==="USER_LOGIN"&&a.payload.user.isLogined)P(n,s,o),E("/chat");else if(!i&&a.type==="ERROR"){const c=document.querySelector(".login"),l=r("p","invalid-password");console.log(l),l.textContent=a.payload.error.toUpperCase(),c.appendChild(l),t.close()}}function q(t,e,n){const o=r("li",e?"user user-online":"user user-offline");o.textContent=t,n.prepend(o)}async function U(t,e){const n=document.querySelector(".chat__list-user"),s=document.createDocumentFragment();t.forEach(o=>{const{login:a,isLogined:i}=o;a!==e&&q(a,i,s)}),n.appendChild(s)}async function N(t){const{login:e,isLogined:n}=t,s=document.querySelector(".chat__list-user"),o=document.querySelectorAll(".user"),a=Array.from(o).filter(i=>i.textContent===e);if(a.length!==0){const i=a[0];s.removeChild(i),n?s.prepend(i):s.appendChild(i),i.classList.toggle("user-offline"),i.classList.toggle("user-online");const c=document.querySelector(".user-login");c&&i.textContent===c.textContent&&T(t)}else q(e,n,s)}let d;const y={get ws(){return d}};async function pt(t,e){const n=JSON.parse(t.data),{type:s,payload:o}=n;switch(s){case"USER_ACTIVE":await U(o.users,e);break;case"USER_INACTIVE":await U(o.users,e);break;case"USER_EXTERNAL_LOGIN":await N(o.user);break;case"USER_EXTERNAL_LOGOUT":await N(o.user);break;case"MSG_FROM_USER":await W(o.messages,e);break;case"MSG_SEND":await X(o.message,e,o.message.id);break;case"MSG_DELIVER":x(o.message);break;case"MSG_READ":x(o.message);break}}function k(t,e,n=""){d=new WebSocket("ws://localhost:4000"),d.onopen=()=>{gt(d,t,e,n),ht()},setTimeout(()=>{d.onmessage=async s=>{ft(d,s,t,e,n),pt(s,t)}},0)}function vt(){d&&d.close()}async function bt(){const t=b();if(t){const{login:e,id:n,password:s}=t;k(e,s,n)}}const yt=""+new URL("rs_school-DDD5qqfv.png",import.meta.url).href;function St(t){const e=r("footer","footer",t),n=r("a","footer__git",e);n.href="https://github.com/Jezhora",n.textContent="Jezhora 2024",n.setAttribute("target","blank");const s=r("a","footer__git",e);s.href="https://rs.school/",s.textContent="The Rolling Scopes",s.setAttribute("target","blank");const o=r("img","footer__logo",e);o.src=`${yt}`,o.alt="RSschool",o.width=150}function _t(){const t=r("div","container",document.body),e=rt(t);t.appendChild(e);const n=r("main","main",t);b()?bt():p(n),St(t)}function Ct(){const t=document.createElement("meta");t.setAttribute("charset","UTF-8"),document.head.appendChild(t);const e=document.createElement("meta");e.setAttribute("name","viewport"),e.setAttribute("content","width=device-width, initial-scale=1.0"),document.head.appendChild(e);const n=document.createElement("link");n.rel="icon",n.type="image/x-icon",n.href="images/favicon.ico",document.head.appendChild(n);const s=document.createElement("title");s.textContent="RS FunChat",document.head.appendChild(s)}window.addEventListener("DOMContentLoaded",()=>{Ct(),_t();const t=window.location.pathname;L(t),window.addEventListener("popstate",e=>{const n=e.state?e.state.path:window.location.pathname;L(n)})});
