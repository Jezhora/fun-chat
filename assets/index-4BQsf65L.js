var H=Object.defineProperty;var W=(e,t,s)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var m=(e,t,s)=>(W(e,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=s(o);fetch(o.href,i)}})();class A{constructor(t,s){m(this,"tag");m(this,"className");m(this,"element");this.tag=t,this.className=s,this.element=document.createElement(t),this.element.className=s}addToParent(t){t.appendChild(this.element)}}class R extends A{constructor(s,n,o){super("button",s);m(this,"button");this.button=this.element,this.button.type=n,o&&this.button.addEventListener("click",o)}}class z extends A{constructor(s,n,o){super("input",s);m(this,"value");m(this,"type");m(this,"isValid");const i=this.element;i.placeholder=o,i.type=n,this.type=n,this.value="",this.isValid=!1,this.validateInput()}validateInput(){this.element.addEventListener("input",s=>{const n=s.target;let o=/^[a-zA-Z0-9]*$/;this.type==="password"&&(o=/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9-]+$/),this.isValid=o.test(n.value),this.value=n.value;const i=new CustomEvent("inputValidated",{detail:this.isValidInput()});document.dispatchEvent(i)})}isValidInput(){return this.isValid}getInputValue(){return this.value.trim()}}function c(e,t,s){const n=new A(e,t);return s&&n.addToParent(s),n.element}function h(e,t,s,n){const o=n?new R(e,t,n):new R(e,t);return o.element.textContent=s,o.element}function L(e,t,s,n){const o=new z(e,t,s);return n&&o.addToParent(n),o}function w(e,t,s,n,o){const i={id:s,login:e,password:t,isLogined:n,isDisconnectMessage:o};sessionStorage.setItem("chat-user",JSON.stringify(i))}function f(){const e=sessionStorage.getItem("chat-user");return e?JSON.parse(e):null}function X(){sessionStorage.removeItem("chat-user")}function x(e,t){const s=c("div","title",e);s.textContent=t}function Y(){const e=document.createDocumentFragment(),t=c("div","chat__user");c("div","chat__user-info",t);const s=c("div","chat__wrapper",t),n=c("div","chat__user-message",s);x(n,"Pick user and go FUN_CHAT!");const o=c("form","chat__send",t);L("send-input","text","write message",o).element.setAttribute("disabled","true");const a=h("btn send-button","submit","send");return a.setAttribute("disabled","true"),o.appendChild(a),e.append(t),e}function g(){const e="0123456789",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",s="-_",n=e+t+s,o=7;let i="";i+=e.charAt(Math.floor(Math.random()*e.length)),i+=s.charAt(Math.floor(Math.random()*s.length));for(let a=2;a<=o;a+=1)i+=n.charAt(Math.floor(Math.random()*n.length));return i=i.split("").sort(()=>.5-Math.random()).join(""),i}function Z(){const{ws:e}=p,s={id:g(),type:"USER_ACTIVE",payload:null},o={id:g(),type:"USER_INACTIVE",payload:null};e.send(JSON.stringify(s)),e.send(JSON.stringify(o))}function j(e,t,s,n){const o={id:n,type:"USER_LOGIN",payload:{user:{login:t,password:s}}};e.send(JSON.stringify(o))}function K(e,t,s,n,o){const i=JSON.parse(t.data),a=f();if(i.type==="USER_LOGIN"&&i.payload.user.isLogined){w(s,n,o,!0,!1);const r=document.querySelector(".modal");b("/chat"),r&&$()}else if(!a&&i.type==="ERROR"){const r=document.querySelector(".login"),d=c("p","invalid-password");d.textContent=i.payload.error.toUpperCase(),r.appendChild(d),e.close()}}function V(e){const t=document.querySelector(".chat__user-info"),{login:s,isLogined:n}=e;v(t);const o=c("div","user user-login",t);o.textContent=s;const i=c("div","user user-status",t);n?(i.classList.add("user-online"),i.textContent="online"):(i.classList.add("user-offline"),i.textContent="offline")}function G(e,t,s){const o=c("li",t?"user user-online":"user user-offline");o.textContent=e,s.prepend(o)}async function T(e,t){const s=document.querySelector(".chat__list-user"),n=document.createDocumentFragment();e.forEach(o=>{const{login:i,isLogined:a}=o;i!==t&&G(i,a,n)}),s.appendChild(n)}async function q(e){const{login:t,isLogined:s}=e,n=document.querySelector(".chat__list-user"),o=document.querySelectorAll(".user"),i=Array.from(o).filter(a=>a.textContent===t);if(i.length!==0){const a=i[0];n.removeChild(a),s?n.prepend(a):n.appendChild(a),a.classList.toggle("user-offline"),a.classList.toggle("user-online");const r=document.querySelector(".user-login");r&&a.textContent===r.textContent&&V(e)}else G(t,s,n)}let u;const p={get ws(){return u}};async function Q(e,t){const s=JSON.parse(e.data),{type:n,payload:o}=s;switch(n){case"USER_ACTIVE":await T(o.users,t);break;case"USER_INACTIVE":await T(o.users,t);break;case"USER_EXTERNAL_LOGIN":await q(o.user);break;case"USER_EXTERNAL_LOGOUT":await q(o.user);break;case"MSG_FROM_USER":await ne(o.messages,t);break;case"MSG_SEND":await ae(o.message,t);break;case"MSG_DELIVER":y(o.message);break;case"MSG_READ":y(o.message);break;case"MSG_DELETE":y(o.message);break;case"MSG_EDIT":y(o.message);break}}let _=0;const O=5;function I(e,t,s=""){u=new WebSocket("ws://localhost:4000"),u.onopen=()=>{j(u,e,t,s),Z()},setTimeout(()=>{u.onmessage=n=>{K(u,n,e,t,s),Q(n,e)}},0),u.onclose=()=>{let n=f();if(n){const{login:o,password:i,id:a}=n;if(n.isDisconnectMessage||(b("/disconnect"),w(o,i,a,!1,!0),n=f()),_<O)_+=1,setTimeout(()=>{I(o,i,a),$()},2e3);else{const r=document.querySelector(".container"),d=document.querySelector(".modal");n&&d&&r&&_===O&&(d.remove(),r.classList.remove("blur"),b("/"),u.close(),w(o,i,a,!1,!1))}}}}function ee(){X(),u&&u.close()}function te(e){const t=new Date(e),s=t.toLocaleString("en-GB",{weekday:"short"}),n=t.getDate(),o=t.toLocaleString("en-GB",{month:"short"}),i=t.getFullYear(),a=t.toLocaleTimeString("en-GB",{hourCycle:"h23",hour:"2-digit",minute:"2-digit",second:"2-digit"});return`${s}, ${n} ${o} ${i}, ${a}`}function se(e,t){const{isReaded:s,isDelivered:n,isEdited:o}=e;let i;if(t&&typeof e=="boolean")i=t;else switch(!0){case o:s&&n?i="Edited Read":n?i="Edited Delivered":i="Edited Sent";break;case s:o?i="Edited Read":i="Read";break;case n:o?i="Edited Delivered":i="Delivered";break;default:o?i=" Edited Sent":i="Sent";break}return i}function F(e,t){const s=document.createDocumentFragment(),n=c("div","message",s);n.setAttribute("id",e.id),e.status.isDelivered&&!e.status.isReaded&&n.classList.add("delivered");const o=c("p","message-status");if(t===e.from){const r=c("p","message-to",n);r.textContent=`To ${e.to}`,n.style.marginLeft="auto",n.style.marginRight="0",o.textContent=se(e.status)}else{const r=c("p","message-from",n);r.textContent=`From ${e.from}`}const i=c("p","message-date",n);i.textContent=te(e.datetime);const a=c("p","message-text",n);return a.textContent=e.text,n.appendChild(o),s}async function ne(e,t){const s=document.querySelector(".chat__user-message");e.forEach(n=>{const o=F(n,t);if(s.lastChild&&o.firstChild){const i=s.lastChild,a=o.firstChild;!i.classList.contains("delivered")&&a.classList.contains("delivered")&&a.classList.add("unread")}s.appendChild(o)})}function oe(e){const t=document.querySelector(".chat__user-message");v(t);const s={id:g(),type:"MSG_FROM_USER",payload:{user:{login:e}}},{ws:n}=p;n.send(JSON.stringify(s)),setTimeout(()=>{Array.from(t.children).some(i=>i.classList.contains("message"))||(x(t,"write your message"),x(t,`to ${e}`))},100)}const E=e=>{Array.from(e.children).forEach(t=>{if(t.classList.contains("delivered")){const s={id:g(),type:"MSG_READ",payload:{message:{id:t.id}}},{ws:n}=p;n.send(JSON.stringify(s))}})};function ie(){const e=document.querySelector(".chat__user-message"),t=document.querySelector(".chat__wrapper"),s=document.querySelector(".send-input");e.addEventListener("click",()=>{E(e)}),t.addEventListener("scroll",()=>{E(e)}),s.addEventListener("input",()=>{s.value.length===1&&E(e)})}function y(e){const{id:t,status:s,text:n}=e,o=document.getElementById(t);if(o){const i=o.querySelector(".message-status"),a=i.textContent,r=o.querySelector(".message-text");let d="";if(i){switch(!0){case s.isReaded:o.classList.remove("delivered"),setTimeout(()=>{o.classList.remove("unread")},1500),o.firstChild&&o.firstChild.className==="message-to"&&(a!=null&&a.startsWith("Edited")?d="Edited Read":d="Read");break;case s.isEdited:a!=null&&a.startsWith("Edited")?(d=`${a}`,r.textContent=n):(d=`Edited ${a}`,r.textContent=n);break;case s.isDeleted:o.remove();break;default:a!=null&&a.startsWith("Edited")?d="Edited Delivered":d="Delivered",o.classList.add("delivered");break}i.textContent=d}}}async function ae(e,t){const s=document.querySelector(".user-login"),n=document.querySelector(".chat__user-message");if(Array.from(n.children).some(i=>i.classList.contains("message"))||v(n),s&&(s.textContent===e.from||s.textContent===e.to)){const a=F(e,t),r=document.querySelector(".chat__user-message");if(r.lastChild&&a.firstChild){const d=r.lastChild,l=a.firstChild,B=l.firstChild;!d.classList.contains("delivered")&&l.classList.contains("delivered")&&B.classList.contains("message-from")&&l.classList.add("unread")}r.appendChild(a)}}function ce(e,t){e.value.length>0?t.removeAttribute("disabled"):t.setAttribute("disabled","true")}const re=(e,t,s,n)=>{e.preventDefault();const o={id:g(),type:"MSG_SEND",payload:{message:{to:n,text:t.value}}},{ws:i}=p;i.send(JSON.stringify(o)),t.value="",s.setAttribute("disabled","true")};function de(e){const t=document.querySelector(".chat__send"),s=t.firstChild,n=t.lastChild;s.removeAttribute("disabled"),s.addEventListener("input",o=>{const i=o.target;i&&ce(i,n)}),t.onsubmit=o=>{re(o,s,n,e)}}function le(e){const t=e.target;if(t&&t.classList.contains("user")){const s=t.textContent,n=t.classList.contains("user-online"),o={login:s,isLogined:n};de(s),V(o),oe(s),ie()}}function ue(e,t){const n=e.target.value.trim().toLowerCase();Array.from(t).forEach(o=>{var a;(a=o.textContent)!=null&&a.toLowerCase().startsWith(n)?o.classList.remove("hide"):o.classList.add("hide")})}function me(){const e=document.createDocumentFragment(),t=c("div","chat__list"),s=L("chat__list-search","search","find user...",t).element,n=c("div","chat__list-wrapper",t),o=c("ul","chat__list-user",n);return s.addEventListener("input",i=>ue(i,o.children)),o.addEventListener("click",le),e.append(t),e}function fe(e){const t={id:null,type:"MSG_DELETE",payload:{message:{id:e,status:{isDeleted:!0}}}},{ws:s}=p;s.send(JSON.stringify(t))}function ge(e,t){const s=document.querySelector(".send-input"),n=s.nextSibling,o=s.parentElement;s.value=t,n.removeAttribute("disabled");const i=o.onsubmit,a={id:g(),type:"MSG_EDIT",payload:{message:{id:e,text:t}}},{ws:r}=p,d=l=>{l.preventDefault(),a.payload.message.text=s.value,r.send(JSON.stringify(a)),s.value="",n.setAttribute("disabled","true"),o.onsubmit=i};o.onsubmit=d}function he(){const e=c("ul","context-menu hide"),t=c("li","context-edit",e),s=c("li","context-delete",e);t.textContent="Edit",s.textContent="delete",document.body.appendChild(e);let n=null;function o({x:r,y:d},l){e.classList.remove("hide"),e.style.left=`${r}px`,e.style.top=`${d}px`,e.style.display="block",n=l}function i(){e.style.display="none"}t.addEventListener("click",()=>{if(n){const r=n.children[2].textContent,d=n.id;ge(d,r),i()}}),s.addEventListener("click",()=>{n&&(n.remove(),fe(n.id)),i()});const a=document.querySelector(".chat__user-message");if(!a){console.error("Message container not found!");return}a.addEventListener("contextmenu",r=>{r.preventDefault();const d=r.target,l=d.firstChild;d&&d.classList.contains("message")&&l&&l.classList.contains("message-to")&&o({x:r.pageX,y:r.pageY},d)}),document.addEventListener("click",i)}function pe(e){const t=c("div","chat",e),s=me(),n=Y();setTimeout(()=>{he()},100),t.append(s,n)}const ve=(e,t,s)=>{s.preventDefault();const n=document.querySelector(".modal");t.classList.remove("blur"),e.removeChild(n)};function be(){const e=document.querySelector(".container");e.classList.add("blur");const t=c("div","modal",document.body),s=c("div","modal__wrapper",t),n=c("div","about",s),o=c("div","about__info",n);o.textContent="This application was developed for the Fun Chat work assignments as part of the RSSchool JS/FE 2023Q4";const i=c("a","about__info",n);i.href="https://github.com/Jezhora",i.textContent="Yauheni Jezhora";const a=h("btn","button","back",r=>ve(document.body,e,r));n.appendChild(a)}const ye=e=>{e.preventDefault(),be()};function Se(e){const t=c("h1","title",e);t.textContent="RS FUN-CHAT";const s=h("btn","button","ABOUT",ye);e.append(s)}function J(e){const t=document.querySelector(".logout");e.removeChild(t)}const P=e=>{const t=document.querySelector(".container"),s=document.querySelector(".modal");if(e.preventDefault(),t&&s){t.classList.remove("blur"),s.remove();const{ws:n}=p;n.close()}ee(),b("/")};function D(e,t){const s=c("div","logout",e),n=c("p","logout__name",s);n.textContent=`${t}`;const o=h("btn","button","LOG OUT",P);s.appendChild(o)}function Ce(e){const t=c("header","header",e);return Se(t),t}const S=(e,t)=>{Array.from(e.children).forEach(s=>{s.classList.contains(t)&&e.removeChild(s)})},k=(e,t,s)=>{const n=c("div",t);e.appendChild(n),n.textContent=s};function N(e,t,s,n){const o=s.isValidInput(),{length:i}=s.getInputValue();i>=t&&o&&S(e,n),i<t&&(S(e,n),k(e,n,`Must contain at least ${t} symbols`)),i<1&&S(e,n),!o&&i>=t&&(S(e,n),k(e,n,n==="invalid-login"?"English letters, numbers are allowed":"Must contain uppercase and lowercase letters with numbers"))}function Le(e,t){const s=e.isValidInput(),n=t.isValidInput(),o=e.getInputValue().length,i=t.getInputValue().length,a=o>2&&i>3;return s&&n&&a}function _e(e,t,s,n){Le(e,t)?s.removeAttribute("disabled"):s.setAttribute("disabled","true"),N(n,3,e,"invalid-login"),N(n,4,t,"invalid-password")}async function Ee(e,t,s){e.preventDefault();const n=g();I(t.value.trim(),s.value.trim(),n)}const we=e=>{e.preventDefault(),b("/")};function C(e,t){const s=c("form","login",e),n=L("login__input user-name","text","login",s),o=L("login__input user-password","password","password",s),i=h("btn","submit","go chat");i.setAttribute("disabled","true"),document.addEventListener("inputValidated",()=>_e(n,o,i,s)),s.appendChild(i);const a=n.element,r=o.element;t&&(a.disabled=t,r.disabled=t),s.onsubmit=d=>Ee(d,a,r)}function v(e){for(;e.firstChild;)e.removeChild(e.lastChild)}function xe(e,t="404 Page not found"){const s=c("p","title");s.textContent=t,s.style.fontSize="74px";const n=h("btn","button","GO LOGIN PAGE",we);e.append(s,n)}const U=e=>{e.children.length>2&&J(e)};function M(e){const t=document.querySelector(".main"),s=document.querySelector(".header"),n=f();switch(e){case"/":v(t),n&&n.isLogined?(C(t,!0),J(s),D(s,n.login)):(C(t),U(s));break;case"/chat":v(t),n?(U(s),D(s,n.login),pe(t)):xe(t,"To access, enter your login and password");break;case"/disconnect":Ae();break;default:v(t),C(t);break}}function b(e){window.history.pushState({path:e},"",e),M(e)}async function Me(){const e=f();if(e){const{login:t,id:s,password:n}=e;I(t,n,s)}}function Ae(){document.querySelector(".container").classList.add("blur");const t=c("div","modal",document.body),s=c("div","modal__wrapper",t),n=c("div","about",s),o=c("div","about__info",n);o.textContent="Disconnect ...";const i=c("div","about__info",n);i.textContent="Attempting to reconnect ...";const a=h("btn","button","go home page",P);n.appendChild(a)}function $(){const e=f();if(e){const{isLogined:t}=e;if(t){b("/chat");const s=document.querySelector(".modal"),n=document.querySelector(".container");s&&n&&(s.remove(),n.classList.remove("blur"))}}}const Ie=""+new URL("rs_school-DDD5qqfv.png",import.meta.url).href;function Re(e){const t=c("footer","footer",e),s=c("a","footer__git",t);s.href="https://github.com/Jezhora",s.textContent="Jezhora 2024",s.setAttribute("target","blank");const n=c("a","footer__git",t);n.href="https://rs.school/",n.textContent="The Rolling Scopes",n.setAttribute("target","blank");const o=c("img","footer__logo",t);o.src=`${Ie}`,o.alt="RSschool"}function Te(){const e=c("div","container",document.body),t=Ce(e);e.appendChild(t);const s=c("main","main",e);f()?Me():C(s),Re(e)}function qe(){const e=document.createElement("meta");e.setAttribute("charset","UTF-8"),document.head.appendChild(e);const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width, initial-scale=1.0"),document.head.appendChild(t);const s=document.createElement("link");s.rel="icon",s.type="image/x-icon",s.href="images/favicon.ico",document.head.appendChild(s);const n=document.createElement("title");n.textContent="RS FunChat",document.head.appendChild(n)}window.addEventListener("DOMContentLoaded",()=>{qe(),Te();const e=window.location.pathname;M(e),window.addEventListener("popstate",t=>{const s=t.state?t.state.path:window.location.pathname;M(s)})});
