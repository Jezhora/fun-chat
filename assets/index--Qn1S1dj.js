var G=Object.defineProperty;var F=(e,t,s)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var d=(e,t,s)=>(F(e,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();class x{constructor(t,s){d(this,"tag");d(this,"className");d(this,"element");this.tag=t,this.className=s,this.element=document.createElement(t),this.element.className=s}addToParent(t){t.appendChild(this.element)}}class M extends x{constructor(s,n,o){super("button",s);d(this,"button");this.button=this.element,this.button.type=n,o&&this.button.addEventListener("click",o)}}class P extends x{constructor(s,n,o){super("input",s);d(this,"value");d(this,"type");d(this,"isValid");const a=this.element;a.placeholder=o,a.type=n,this.type=n,this.value="",this.isValid=!1,this.validateInput()}validateInput(){this.element.addEventListener("input",s=>{const n=s.target;let o=/^[a-zA-Z0-9]*$/;this.type==="password"&&(o=/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])[a-zA-Z0-9-]+$/),this.isValid=o.test(n.value),this.value=n.value;const a=new CustomEvent("inputValidated",{detail:this.isValidInput()});document.dispatchEvent(a)})}isValidInput(){return this.isValid}getInputValue(){return this.value.trim()}}function r(e,t,s){const n=new x(e,t);return s&&n.addToParent(s),n.element}function f(e,t,s,n){const o=n?new M(e,t,n):new M(e,t);return o.element.textContent=s,o.element}function b(e,t,s,n){const o=new P(e,t,s);return n&&o.addToParent(n),o}function J(e,t,s){const n={id:s,login:e,password:t};sessionStorage.setItem("chat-user",JSON.stringify(n))}function S(){const e=sessionStorage.getItem("chat-user");return e?JSON.parse(e):null}function $(){sessionStorage.removeItem("chat-user")}function g(){const e="0123456789",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",s="-_",n=e+t+s,o=7;let a="";a+=e.charAt(Math.floor(Math.random()*e.length)),a+=s.charAt(Math.floor(Math.random()*s.length));for(let i=2;i<=o;i+=1)a+=n.charAt(Math.floor(Math.random()*n.length));return a=a.split("").sort(()=>.5-Math.random()).join(""),a}function L(e,t){const s=r("div","title",e);s.textContent=t}function B(){const e=document.createDocumentFragment(),t=r("div","chat__user");r("div","chat__user-info",t);const s=r("div","chat__wrapper",t),n=r("div","chat__user-message",s);L(n,"Pick user and go FUN_CHAT!");const o=r("form","chat__send",t);b("send-input","text","write message",o).element.setAttribute("disabled","true");const i=f("btn send-button","submit","send");return i.setAttribute("disabled","true"),o.appendChild(i),e.append(t),e}function H(e){const t=new Date(e),s=t.toLocaleString("en-GB",{weekday:"short"}),n=t.getDate(),o=t.toLocaleString("en-GB",{month:"short"}),a=t.getFullYear(),i=t.toLocaleTimeString("en-GB",{hourCycle:"h23",hour:"2-digit",minute:"2-digit",second:"2-digit"});return`${s}, ${n} ${o} ${a}, ${i}`}function W(e,t){const{isReaded:s,isDelivered:n}=e;let o;if(t&&typeof e=="boolean")o=t;else switch(!0){case s:o="Read";break;case n:o="Delivered";break;default:o="Sent";break}return o}function w(e,t){const s=document.createDocumentFragment(),n=r("div","message",s);n.setAttribute("id",e.id),e.status.isDelivered&&!e.status.isReaded&&n.classList.add("delivered");const o=r("p","message-status");if(t===e.from){const c=r("p","message-to",n);c.textContent=`To ${e.to}`,n.style.marginLeft="auto",n.style.marginRight="0",o.textContent=W(e.status)}else{const c=r("p","message-from",n);c.textContent=`From ${e.from}`}const a=r("p","message-date",n);a.textContent=H(e.datetime);const i=r("p","message-text",n);return i.textContent=e.text,n.appendChild(o),s}async function z(e,t){const s=document.querySelector(".chat__user-message");e.forEach(n=>{const o=w(n,t);s.appendChild(o)})}function X(e){const t=document.querySelector(".chat__user-message");m(t);const s={id:g(),type:"MSG_FROM_USER",payload:{user:{login:e}}},{ws:n}=h;n.send(JSON.stringify(s)),setTimeout(()=>{Array.from(t.children).some(a=>a.classList.contains("message"))||(L(t,"write your message"),L(t,`to ${e}`))},100)}function N(e){const t=document.querySelector(".chat__user-info"),{login:s,isLogined:n}=e;m(t);const o=r("div","user user-login",t);o.textContent=s;const a=r("div","user user-status",t);n?(a.classList.add("user-online"),a.textContent="online"):(a.classList.add("user-offline"),a.textContent="offline")}const C=e=>{Array.from(e.children).forEach(t=>{if(t.classList.contains("delivered")){const s={id:g(),type:"MSG_READ",payload:{message:{id:t.id}}},{ws:n}=h;n.send(JSON.stringify(s))}})};function Y(){const e=document.querySelector(".chat__user-message"),t=document.querySelector(".chat__wrapper"),s=document.querySelector(".send-input");e.addEventListener("click",()=>{C(e)}),t.addEventListener("scroll",()=>{C(e)}),s.addEventListener("input",()=>{s.value.length===1&&C(e)})}function _(e){const{id:t,status:s,text:n}=e,o=document.getElementById(t);if(o){const a=o.querySelector(".message-status"),i=o.querySelector(".message-text");let c="";if(a){switch(!0){case s.isReaded:o.firstChild&&o.firstChild.className==="message-to"&&(c="Read",o.classList.remove("delivered"));break;case s.isEdited:c=`Edited ${o.textContent}`,i.textContent=n;break;case s.isDeleted:o.remove();break;default:c="Delivered",o.classList.add("delivered");break}a.textContent=c}}}async function Z(e,t,s){const n=document.querySelector(".user-login"),o=document.querySelector(".chat__user-message");if(Array.from(o.children).some(i=>i.classList.contains("message"))||m(o),n&&(n.textContent===e.from||n.textContent===e.to)){const c=w(e,t);document.querySelector(".chat__user-message").appendChild(c)}}function j(e,t){e.value.length>0?t.removeAttribute("disabled"):t.setAttribute("disabled","true")}function K(e){const t=document.querySelector(".chat__send"),s=t.firstChild,n=t.lastChild;s.removeAttribute("disabled"),s.addEventListener("input",a=>{const i=a.target;i&&j(i,n)});const{ws:o}=h;t.onsubmit=a=>{a.preventDefault();const i={id:g(),type:"MSG_SEND",payload:{message:{to:e,text:s.value}}};o.send(JSON.stringify(i)),s.value="",n.setAttribute("disabled","true")}}function Q(e){const t=e.target;if(t&&t.classList.contains("user")){const s=t.textContent,n=t.classList.contains("user-online"),o={login:s,isLogined:n};K(s),N(o),X(s),Y()}}function ee(e,t){const n=e.target.value.trim().toLowerCase();Array.from(t).forEach(o=>{var i;(i=o.textContent)!=null&&i.toLowerCase().startsWith(n)?o.classList.remove("hide"):o.classList.add("hide")})}function te(){const e=document.createDocumentFragment(),t=r("div","chat__list"),s=b("chat__list-search","search","find user...",t).element,n=r("div","chat__list-wrapper",t),o=r("ul","chat__list-user",n);return s.addEventListener("input",a=>ee(a,o.children)),o.addEventListener("click",Q),e.append(t),e}function se(e){const t={id:null,type:"MSG_DELETE",payload:{message:{id:e,status:{isDeleted:!0}}}},{ws:s}=h;s.send(JSON.stringify(t))}function ne(){const e=r("ul","context-menu"),t=r("li","context-edit",e),s=r("li","context-delete",e);t.textContent="Edit",s.textContent="delete",document.body.appendChild(e);let n=null;function o({x:c,y:u},p){e.style.left=`${c}px`,e.style.top=`${u}px`,e.style.display="block",n=p}function a(){e.style.display="none"}t.addEventListener("click",()=>{n&&console.log(n.id),a()}),s.addEventListener("click",()=>{n&&(n.remove(),se(n.id)),a()});const i=document.querySelector(".chat__user-message");if(!i){console.error("Message container not found!");return}i.addEventListener("contextmenu",c=>{c.preventDefault();const u=c.target,p=u.firstChild;u&&u.classList.contains("message")&&p&&p.classList.contains("message-to")&&o({x:c.pageX,y:c.pageY},u)}),document.addEventListener("click",a)}function oe(e){const t=r("div","chat",e),s=te(),n=B();setTimeout(()=>{ne()},100),t.append(s,n)}const ae=(e,t,s)=>{e.preventDefault();const n=document.querySelector(".modal");s.classList.remove("blur"),t.removeChild(n)};function ie(){const e=document.querySelector(".container");e.classList.add("blur");const t=r("div","modal",document.body),s=r("div","modal__wrapper",t),n=r("div","about",s),o=r("div","about__info",n);o.textContent="This application was developed for the Fun Chat work assignments as part of the RSSchool JS/FE 2023Q4";const a=r("a","about__info",n);a.href="https://github.com/Jezhora",a.textContent="Yauheni Jezhora";const i=f("btn","button","back",c=>ae(c,document.body,e));n.appendChild(i)}const re=e=>{e.preventDefault(),ie()};function ce(e){const t=r("h1","title",e);t.textContent="RS FUN-CHAT";const s=f("btn","button","ABOUT",re);e.append(s)}function q(e){const t=document.querySelector(".logout");e.removeChild(t)}const ue=e=>{e.preventDefault(),$(),Se(),A("/")};function I(e,t){const s=r("div","logout",e),n=r("p","logout__name",s);n.textContent=`${t}`;const o=f("btn","button","LOG OUT",ue);s.appendChild(o)}function de(e){const t=r("header","header",e);return ce(t),t}const y=(e,t)=>{Array.from(e.children).forEach(s=>{s.classList.contains(t)&&e.removeChild(s)})},O=(e,t,s)=>{const n=r("div",t);e.appendChild(n),n.textContent=s};function R(e,t,s,n){const o=s.isValidInput(),{length:a}=s.getInputValue();a>=t&&o&&y(e,n),a<t&&(y(e,n),O(e,n,`Must contain at least ${t} symbols`)),a<1&&y(e,n),!o&&a>=t&&(y(e,n),O(e,n,n==="invalid-login"?"English letters, numbers are allowed":"Must contain uppercase and lowercase letters with numbers"))}function le(e,t){const s=e.isValidInput(),n=t.isValidInput(),o=e.getInputValue().length,a=t.getInputValue().length,i=o>2&&a>3;return s&&n&&i}function me(e,t,s,n){le(e,t)?s.removeAttribute("disabled"):s.setAttribute("disabled","true"),R(n,3,e,"invalid-login"),R(n,4,t,"invalid-password")}async function ge(e,t,s){e.preventDefault();const n=g();V(t.value.trim(),s.value.trim(),n)}const fe=e=>{e.preventDefault(),A("/")};function v(e,t){const s=r("form","login",e),n=b("login__input user-name","text","login",s),o=b("login__input user-password","password","password",s),a=f("btn","submit","go chat");a.setAttribute("disabled","true"),document.addEventListener("inputValidated",()=>me(n,o,a,s)),s.appendChild(a);const i=n.element,c=o.element;t&&(i.disabled=t,c.disabled=t),s.onsubmit=u=>ge(u,i,c)}function m(e){for(;e.firstChild;)e.removeChild(e.lastChild)}function he(e,t="404 Page not found"){const s=r("p","title");s.textContent=t,s.style.fontSize="74px";const n=f("btn","button","GO LOGIN PAGE",fe);e.append(s,n)}const T=e=>{e.children.length>2&&q(e)};function E(e){const t=document.querySelector(".main"),s=document.querySelector(".header"),n=S();switch(e){case"/":m(t),n?(v(t,!0),q(s),I(s,n.login)):(v(t),T(s));break;case"/chat":m(t),n?(T(s),I(s,n.login),oe(t)):he(t,"To access, enter your login and password");break;default:m(t),v(t);break}}function A(e){window.history.pushState({path:e},"",e),E(e)}function pe(){const{ws:e}=h,s={id:g(),type:"USER_ACTIVE",payload:null},o={id:g(),type:"USER_INACTIVE",payload:null};e.send(JSON.stringify(s)),e.send(JSON.stringify(o))}function ye(e,t,s,n){const o={id:n,type:"USER_LOGIN",payload:{user:{login:t,password:s}}};e.send(JSON.stringify(o))}function ve(e,t,s,n,o){const a=JSON.parse(t.data),i=S();if(a.type==="USER_LOGIN"&&a.payload.user.isLogined)J(s,n,o),A("/chat");else if(!i&&a.type==="ERROR"){const c=document.querySelector(".login"),u=r("p","invalid-password");u.textContent=a.payload.error.toUpperCase(),c.appendChild(u),e.close()}}function D(e,t,s){const o=r("li",t?"user user-online":"user user-offline");o.textContent=e,s.prepend(o)}async function k(e,t){const s=document.querySelector(".chat__list-user"),n=document.createDocumentFragment();e.forEach(o=>{const{login:a,isLogined:i}=o;a!==t&&D(a,i,n)}),s.appendChild(n)}async function U(e){const{login:t,isLogined:s}=e,n=document.querySelector(".chat__list-user"),o=document.querySelectorAll(".user"),a=Array.from(o).filter(i=>i.textContent===t);if(a.length!==0){const i=a[0];n.removeChild(i),s?n.prepend(i):n.appendChild(i),i.classList.toggle("user-offline"),i.classList.toggle("user-online");const c=document.querySelector(".user-login");c&&i.textContent===c.textContent&&N(e)}else D(t,s,n)}let l;const h={get ws(){return l}};async function be(e,t){const s=JSON.parse(e.data),{type:n,payload:o}=s;switch(n){case"USER_ACTIVE":await k(o.users,t);break;case"USER_INACTIVE":await k(o.users,t);break;case"USER_EXTERNAL_LOGIN":await U(o.user);break;case"USER_EXTERNAL_LOGOUT":await U(o.user);break;case"MSG_FROM_USER":await z(o.messages,t);break;case"MSG_SEND":await Z(o.message,t,o.message.id);break;case"MSG_DELIVER":_(o.message);break;case"MSG_READ":_(o.message);break;case"MSG_DELETE":_(o.message);break}}function V(e,t,s=""){l=new WebSocket("ws://localhost:4000"),l.onopen=()=>{ye(l,e,t,s),pe()},setTimeout(()=>{l.onmessage=async n=>{ve(l,n,e,t,s),be(n,e)}},0)}function Se(){l&&l.close()}async function Ce(){const e=S();if(e){const{login:t,id:s,password:n}=e;V(t,n,s)}}const _e=""+new URL("rs_school-DDD5qqfv.png",import.meta.url).href;function Le(e){const t=r("footer","footer",e),s=r("a","footer__git",t);s.href="https://github.com/Jezhora",s.textContent="Jezhora 2024",s.setAttribute("target","blank");const n=r("a","footer__git",t);n.href="https://rs.school/",n.textContent="The Rolling Scopes",n.setAttribute("target","blank");const o=r("img","footer__logo",t);o.src=`${_e}`,o.alt="RSschool",o.width=150}function we(){const e=r("div","container",document.body),t=de(e);e.appendChild(t);const s=r("main","main",e);S()?Ce():v(s),Le(e)}function Ee(){const e=document.createElement("meta");e.setAttribute("charset","UTF-8"),document.head.appendChild(e);const t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width, initial-scale=1.0"),document.head.appendChild(t);const s=document.createElement("link");s.rel="icon",s.type="image/x-icon",s.href="images/favicon.ico",document.head.appendChild(s);const n=document.createElement("title");n.textContent="RS FunChat",document.head.appendChild(n)}window.addEventListener("DOMContentLoaded",()=>{Ee(),we();const e=window.location.pathname;E(e),window.addEventListener("popstate",t=>{const s=t.state?t.state.path:window.location.pathname;E(s)})});
